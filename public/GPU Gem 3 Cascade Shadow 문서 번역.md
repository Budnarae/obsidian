---
tags:
  - graphics
  - translation
---

__

---
# Chapter 10. 프로그래머블 GPU에서의 병렬 분할 섀도우 맵

**Fan Zhang**  
홍콩 중문대학교

**Hanqiu Sun**  
홍콩 중문대학교

**Oskari Nyman**  
헬싱키 공과대학교

### **서두**

섀도우 매핑(Williams 1978)은 3D 게임과 애플리케이션에서 섀도잉 효과를 만들어내기 위해 광범위하게 사용되어 왔습니다. 그러나 섀도우 매핑은 고유한 앨리어싱 문제를 가지고 있으므로, 표준 섀도우 매핑을 사용하는 것만으로는 복잡하고 대규모 장면에서 고품질 섀도우 렌더링을 생성하기에 충분하지 않습니다. 이 장에서 우리는 대규모 환경을 위해 안티앨리어스되고 실시간 섀도우를 생성하는 고급 섀도우 매핑 기법을 제시합니다. 또한 현대 프로그래머블 GPU에서 우리 기법의 구현 세부사항을 보여줍니다.

우리가 제시하는 기법은 병렬 분할 섀도우 맵(Parallel-Split Shadow Maps, PSSMs)(Zhang et al. 2007 및 Zhang et al. 2006)이라고 불립니다. 이 기법에서 뷰 프러스텀은 뷰 평면에 평행한 클립 평면을 사용하여 여러 깊이 레이어로 분할되며, 각 레이어에 대해 독립적인 섀도우 맵이 렌더링됩니다(Figure 10-1 참조).

**Figure 10-1 병렬 분할 섀도우 맵**

분할 방식은 뷰어로부터 다른 거리에 있는 점들이 다른 섀도우 맵 샘플링 밀도를 필요로 한다는 관찰에서 동기를 얻습니다. 뷰 프러스텀을 여러 부분으로 분할함으로써, 각 섀도우 맵이 더 작은 영역을 샘플링할 수 있도록 하여 텍스처 공간에서 샘플링 주파수가 증가하게 됩니다. 뷰 공간과 텍스처 공간에서 샘플링 주파수를 더 잘 일치시킴으로써, 섀도우 앨리어싱 오류가 크게 감소합니다.

원근 섀도우 맵(Perspective Shadow Maps, PSMs)(Stamminger and Drettakis 2002), 광원 공간 원근 섀도우 맵(Light-Space Perspective Shadow Maps, LiSPSMs)(Wimmer et al. 2004), 사다리꼴 섀도우 맵(Trapezoidal Shadow Maps, TSMs)(Martin and Tan 2004)과 같은 다른 인기 있는 섀도우 매핑 기법들과 비교하여, PSSMs는 섀도우 맵 텍셀의 왜곡된 분포를 이산적으로 근사하는 직관적인 방법을 제공하지만, 매핑 특이점과 특별한 처리는 없습니다.

여러 개의 섀도우 맵을 사용하는 아이디어는 Tadamura et al. 2001에서 소개되었습니다. 이는 Lloyd et al. 2006에서 더욱 연구되었고, Futuremark의 벤치마크 애플리케이션 3DMark 2006에서 캐스케이드 섀도우 매핑으로 구현되었습니다.

PSSMs를 포함한 이러한 모든 알고리즘의 두 가지 주요 문제는 다음과 같습니다:

- **뷰 프러스텀을 분할하는 방법.** 다시 말해, 분할 평면 위치를 결정하는 방법.
- **렌더링 성능.** 여러 섀도우 맵을 생성하고 여러 섀도우 맵을 샘플링하는 것은 단일 섀도우 맵 방법보다 비용이 더 많이 듭니다.

이 두 가지 문제는 PSSMs에서 잘 처리됩니다. 우리는 빠르고 견고한 장면 독립적 분할 전략을 사용하여 뷰 기반 해상도 요구사항에 적응하며, DirectX 9 레벨 및 DirectX 10 레벨 하드웨어를 활용하여 성능을 향상시키는 방법을 보여줍니다.

이 장에서는 명확성을 위해 방향성 광원을 사용하여 PSSMs 기법을 설명하지만, 구현 세부사항은 포인트 라이트에도 유효합니다. PSSM(m, res) 표기법은 뷰 프러스텀을 m개의 부분으로 분할하는 분할 방식을 나타냅니다. res는 각 섀도우 맵의 해상도입니다. Figure 10-2는 오버헤드 광원을 사용한 분할 방식의 일반적인 구성을 보여주며, 여기서 뷰 프러스텀 V는 z축을 따라 ${C_i \mid 0 \leq i \leq m}$에 있는 클립 평면을 사용하여 ${V_i \mid 0 \leq i \leq m - 1}$로 분할됩니다. 특히, $C_0 = n$(근평면 위치)이고 $C_m = f$(원평면 위치)입니다.

**Figure 10-2 오버헤드 광원을 사용한 분할 방식의 구성**

우리는 다음 단계로 분할 방식 PSSM(m, res)을 적용합니다:

1. 뷰 프러스텀을 m개의 부분 ${V_i}$로 분할합니다.
2. 각 $V_i$에 대해 광원의 뷰 및 투영 행렬을 계산합니다.
3. 각 부분 $V_i$에 대해 섀도우 맵 $T_i$를 생성합니다.
4. 장면을 렌더링하고 각 픽셀에 대해 적절한 섀도우 맵 $T_i$를 샘플링하여 섀도우를 합성합니다.

---

### **10.1 깊이 레이어에 대한 분할 평면 위치 선택**

1단계의 주요 문제는 분할 평면이 어디에 배치되는지를 결정하는 것입니다. 사용자는 애플리케이션별 요구사항에 따라 분할 위치를 조정할 수 있지만, 우리의 구현은 Zhang et al. 2006에서 제안된 실용적 분할 방식(practical split scheme)을 사용합니다.

이 분할 방식을 소개하기 전에, 섀도우 매핑의 앨리어싱 문제를 간략하게 검토하겠습니다. 이는 Stamminger and Drettakis 2002, Wimmer et al. 2004, Lloyd et al. 2006에서 광범위하게 논의되었습니다.

Figure 10-3에서, 텍셀(크기 $d_s$)을 통과하는 광선들은 월드 공간에서 길이 $d_z$를 가진 물체의 표면에 떨어집니다. Direct3D의 표준 투영 행렬로부터, 우리는 표면에서 투영된 뷰 빔의 크기 $d_p$(정규화된 스크린에서)가 $dy(z \tan \theta)^{-1}$임을 알고 있습니다. 여기서 $\theta = \alpha/2$는 뷰 프러스텀의 시야각입니다. Figure 10-3의 표면 로컬 뷰로부터, 우리는 근사식 $dy \approx d_z \cos \phi/\cos \theta$를 얻습니다. 여기서 $\phi$와 $\theta$는 각각 표면 법선과 스크린으로의 벡터, 그리고 섀도우 맵 평면 사이의 각도를 나타냅니다.

**Figure 10-3 섀도우 맵 앨리어싱**

작은 표면에 대한 앨리어싱 오류는 다음과 같이 정의됩니다:

$$\frac{d_p}{d_s} = n \cdot \frac{d_z}{zd_s} \cdot \frac{\cos \phi}{\cos \theta}$$

우리는 일반적으로 이 앨리어싱 표현 $d_p/d_s$를 두 부분으로 분해합니다: 원근 앨리어싱(perspective aliasing) $d_z/zd_s$와 투영 앨리어싱(projection aliasing) $\cos \phi/\cos \theta$(주어진 뷰 행렬에 대해 $n$은 상수입니다). 섀도우 맵 언더샘플링은 원근 앨리어싱 또는 투영 앨리어싱이 커질 때 발생할 수 있습니다.

투영 앨리어싱은 로컬 기하학적 세부사항에 의존하므로, 이러한 종류의 앨리어싱을 줄이려면 각 프레임마다 비용이 많이 드는 장면 분석이 필요합니다. 반면에, 원근 앨리어싱은 원근 단축(perspective foreshortening) 효과에서 비롯되며, 원근 투영 변환을 사용하여 섀도우 평면을 왜곡함으로써 줄일 수 있습니다. 더 중요한 것은, 원근 앨리어싱은 장면 독립적이므로, 원근 앨리어싱을 줄이는 것은 복잡한 장면 분석을 필요로 하지 않습니다.

실용적 분할 방식은 원근 앨리어싱 분석에 기반합니다.

실용적 분할 방식에서, 분할 위치는 다음 방정식으로 결정됩니다:

$$C_i = \lambda C_i^{\text{log}} + (1 - \lambda) C_i^{\text{uniform}}$$

여기서 ${C_i^{\text{log}}}$와 ${C_i^{\text{uniform}}}$은 각각 로그 분할 방식과 균등 분할 방식입니다. 매개변수 $\lambda \in [0, 1]$은 두 방식 사이의 가중치입니다.

**Figure 10-4 섀도우 맵 공간에서 실용적 분할 방식의 시각화**

---

#### **10.1.1 로그 분할 방식**

이론적으로 최적의 원근 앨리어싱 분포는 전체 깊이 범위에 걸쳐 $d_z/zd_s$를 일정하게 만듭니다. Wimmer et al. 2004에 나타난 바와 같이, 다음의 간단한 유도는 최적의 섀도우 맵 매개변수화 $s(z)$를 제공합니다:

$$\frac{d_z}{zd_s} = \rho \quad \text{(여기서 } \rho \text{는 상수)}$$

이를 적분하면:

$$s(z) = \frac{\ln(z)}{\rho} + C$$

여기서 $\rho$는 상수입니다. $s(f) = 1$로부터, 우리는 $\rho = \ln(f/n)$을 얻습니다.

현재 하드웨어에서 지원하는 유일한 비선형 변환은 원근 투영 변환$(s = A/z + B)$이므로, 이전의 로그 매핑을 $z$에서 $s$로 근사하기 위해, 로그 분할 방식은 $z = C_i^{\text{log}}$에서 여러 깊이 레이어로 이를 이산화합니다:

$$s_i = \frac{i}{m} = \frac{\ln(z_i)}{\ln(f/n)}$$

로그 분할 방식은 이론적으로 균등한 원근 앨리어싱 분포를 생성하도록 설계되었기 때문에, 각 분할에 할당되는 해상도는 전체 텍스처 해상도의 $1/m$이어야 합니다. $s_i = i/m$을 앞의 방정식에 대입하면 다음을 얻습니다:

$$C_i^{\text{log}} = n\left(\frac{f}{n}\right)^{i/m}$$

로그 분할 방식의 주요 단점은 실제로 뷰어 근처의 분할 부분 길이가 너무 작아서 이러한 분할 부분에 포함될 수 있는 물체가 거의 없다는 것입니다. 분할 방식 PSSM(3)의 상황을 상상해 보십시오. 즉, 뷰 프러스텀이 세 부분으로 분할됩니다. $f = 1000$이고 $n = 1$인 경우, 첫 번째 분할 $V_0$와 두 번째 분할 $V_1$은 뷰 거리의 1%와 10%만을 차지합니다. 일반적으로 뷰어 근처의 부분에 대해서는 오버샘플링이 발생하고, 뷰어로부터 먼 부분에 대해서는 언더샘플링이 발생합니다. 결과적으로, 실제로 로그 분할 방식은 직접 사용하기 어렵습니다.

---

#### **10.1.2 균등 분할 방식**

균등 분할 방식은 단순히 분할 평면을 뷰 방향을 따라 균등하게 배치합니다:

$$C_i^{\text{uniform}} = n + \frac{(f - n) \cdot i}{m}$$

균등 분할 방식의 앨리어싱 분포는 표준 섀도우 맵의 분포와 동일합니다. 표준 섀도우 맵에서 $s = (z - n)/(f - n)$이기 때문에, 투영 앨리어싱을 무시하면 다음을 얻습니다:

$$\frac{d_z}{zd_s} \approx \frac{f - n}{n + s(f - n)} = \frac{1}{\frac{n}{f - n} + s}$$

이것은 표준 섀도우 맵의 앨리어싱 오류가 물체가 뷰 평면 근처로 이동함에 따라 쌍곡선적으로 증가한다는 것을 의미합니다. 표준 섀도우 매핑과 마찬가지로, 균등 분할 방식은 뷰어 근처의 물체에 대해서는 언더샘플링을, 먼 물체에 대해서는 오버샘플링을 초래합니다.

---

로그 및 균등 분할 방식이 근거리 및 원거리 깊이 레이어에 대해 동시에 적절한 샘플링 밀도를 생성할 수 없기 때문에, 실용적 분할 방식은 로그 및 균등 방식을 통합하여 전체 깊이 범위에 걸쳐 적절한 샘플링 밀도를 생성합니다. 가중치 $\lambda$는 애플리케이션의 실용적 요구사항에 따라 분할 위치를 조정합니다. $\lambda = 0.5$는 우리의 현재 구현에서 기본 설정입니다. Figure 10-4에서, 실용적 분할 방식은 근거리 및 원거리 분할 부분에 대해 적절한 샘플링 밀도를 생성합니다. Figure 10-4에 대한 중요한 참고사항: 각 분할 방식에서 색상화된 샘플링 주파수는 개략적인 설명을 위한 것일 뿐이며, 이론적으로 앨리어싱 분포를 정확하게 시각화하는 것은 아닙니다. 여러 깊이 레이어의 (원근) 앨리어싱 분포에 관심이 있는 독자는 Lloyd et al. 2006을 참조할 수 있습니다.

뷰 프러스텀을 분할하기 전에, 뷰 프러스텀이 가시 물체를 가능한 한 밀접하게 포함하도록 카메라의 근평면과 원평면을 조정할 수 있습니다. 이렇게 하면 뷰 프러스텀의 빈 공간 양이 최소화되어 사용 가능한 섀도우 맵 해상도가 증가합니다.