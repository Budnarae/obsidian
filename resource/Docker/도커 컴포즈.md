
---

#docker

*docker compose*

---

도커 컴포즈는 다음과 같이 정의할 수 있다. 

1. **시스템 구축과 관련된 명령어를 하나의 텍스트 파일(정의 파일)에 기재해 명령어 한번에 시스템 전체를 실행하고 종료와 폐기까지 한 번에 하도록 도와주는 도구**.
2. 시스템 구축에 필요한 설정을 YAML(YAML Ain't a Markup Language) 포맷으로 기재한 정의 파일을 이용해 전체 시스템을 일괄 실행(run) 또는 일괄 종료 및 삭제(down)할 수 있는 도구다.

본래 도커 엔진과 별개의 프로그램으로 존재했지만(구버전. docker-compose로 실행) 도커 측에서 도커 엔진을 설치할 때 도커 컴포즈도 패키지로 같이 설치되도록 방침을 바꾸었다(신버전. docker compose로 실행). 따라서 별도의 파일을 설치할 필요는 없다.

### dcoker-compose.yml

컴포즈 파일의 이름은 미리 정해진 **docker-compose.yml**이라는 이름을 사용해야 한다.

==정의 파일은 한 폴더에 하나만 있을 수 있다.==

#### 정의 파일의 작성

정의 파일은 YAML 형식을 따른다.
정의 파일에는 services와 networks, volumes를 기재할 수 있다.

>##### 서비스와 컨테이너
>
>도커 컴포즈에서는 컨테이너가 모인 것을 '서비스'라고 부른다.
>공식 참조 문서에서는 컨테이너와 서비스라는 두 가지 용어가 함께 사용되는데, 그냥 모두 컨테이너로 이해하면 되므로 큰 문제는 없다.

##### 컴포즈 파일의 주항목

| 항목     | 내용                  |
| -------- | --------------------- |
| services | 컨테이너를 정의한다.  |
| networks | 네트워크를 정의한다. |
| volumes  | 볼륨을 정의한다.      |

##### services의 정의 내용(자주 쓰이는 것)

| 항목        | docker run 커맨드에서 대응되는 옵션 또는 인자 | 내용                                |
| ----------- | --------------------------------------------- | ----------------------------------- |
| image       | 이미지 인자                                   | 사용할 이미지를 지정                |
| networks    | --net                                         | 접속할 네트워크를 지정              |
| volumes     | -v, --mount                                   | 스토리지 마운트를 지정              |
| ports       | -p                                            | 포트 설정                           |
| environment | -e                                            | 환경변수 설정                       |
| depends_on  | 없음                                          | 다른 서비스에 대한 의존관계를 정의  |
| restart     | 없음                                          | 컨테이너 종료 시 재시작 여부를 설정 |

- `depends_on` : 은 다른 서비스에 대한 의존 관계를 나타낸다. 컨테이너를 생성하는 순서를 정의할 수 있다. 예를 들어, penguin 컨테이너의 정의에 
	```
	depends_on -namgeuk
	```
- 라는 내용이 포함되어 있다면 namgeuk 컨테이너를 생성한 다음에 penguin 컨테이너를 만든다.
- `restart` : 컨테이너 종료 시 재시작 여부를 설정한다.

> restart 설정 옵션
>
>| 설정값         | 내용                                                |
| -------------- | --------------------------------------------------- |
| no             | 재시작하지 않는다.                                  |
| always         | 항상 재시작한다.                                    |
| on_failure     | 프로세스가 0 이외의 상태로 종료되었다면 재시작한다. |
| unless_stopped | 종료 시 재시작하지 않음. 그 회에는 재시작한다.      |

##### services의 정의 내용(자주 쓰이지 않는 것)

| 항목           | docker run 커맨드에서 대응되는 옵션 또는 인자 | 내용                                          |
| -------------- | --------------------------------------------- | --------------------------------------------- |
| command        | 커맨드 인자                                   | 컨테이너 시작 시 기존 커맨드를 오버라이드     |
| container_name | --name                                        | 실행할 컨테이너의 이름을 명시적으로 지정      |
| dns            | --dns                                         | DNS 서버를 명시적으로 지정                    |
| env_file       | 없음                                          | 환경설정 정보를 기재한 파일을 로드            |
| entrypoint     | --entrypoint                                  | 컨테이너 시작 시 ENTRYPOINT 설정을 오버라이드 |
| external_links | --link                                        | 외부 링크를 설정                              |
| extra_hosts    | --add-host                                    | 외부 호스트의 IP 주소를 명시적으로 지정       |
| logging        | --log-driver                                  | 로그 출력 대상을 설정                         |
| network_mode   | --network                                     | 네트워크 모드를 설정                          |

##### 예제

```yaml

services:
  mysql000ex11:
    image: mysql:5.7
    networks:
      - wordpress000net1
    volumes:
	  - mysql000vol11:/var/lib/mysql
	restart: always
	environment:
	  MYSQL_ROOT_PASSWORD: myrootpass
	  MYSQL_DATABASE: wordpress000db
	  MYSQL_USER: wordpress000kun
	  MYSQL_PASSWORD: kunpass
	wordpress000ex12:
	  depends_on:
	    - mysql000ex11
	  image: wordpress
	  networks:
	    - wordpress000net1
	  volumes:
	    - wordpress000vol12:/var/www/html
	  ports:
	    - 8080:80
	  restart: always
	  environment:
	    WORDPRESS_DB_HOST: mysql1000ex11
	    WORDPRESS_DB_NAME: wordpress000db
	    WORDPRESS_DB_USER: wordpress000kun
	    WORDPRESS_DB_PASSWORD: wkunpass
networks:
  wordpress000net1:
volumes:
  mysql000vol11:
  wordpress000vol12:

```

### 도커 컴포즈 커맨드

모든 docker compose 커맨드는 docker compose로 시작한다.

현재 작업 디렉토리에 도커 컴포즈 파일이 있다면 그냥 사용한다.
그렇지 않다면, -f 옵션으로 컴포즈 파일의 경로를 지정하여야 한다.

`docker-compose -f <도커 컴포즈 파일 경로> command <옵션 ...>`

#### up

[[도커 명령어#^8a9da8 | docker run 커맨드]]와 유사하다.

정의 파일에 기재된 내용대로 이미지를 내려받고 컨테이너를 생성 및 실행한다. 정의 파일에는 네트워크나 볼륨에 대한 정의도 기재할 수 있어서 주변 환경을 한꺼번에 생성할 수 있다.

| 옵션    | 내용                                   |
| ------- | -------------------------------------- |
| -d      | 백그라운드로 실행                      |
| --build | 컨테이너를 실행하기 전에 이미지를 빌드 |


#### down

정의 파일에 기재된 컨테이너와 네트워크를 정지 및 삭제한다. 볼륨과 이미지는 삭제하지 않는다. 컨테이너와 네트워크 삭제 없이 종료만 하고 싶다면 stop 커맨드를 사용한다.

| 옵션         | 내용                                                                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |
| `--rmi <종류>`   | 삭제 시에 이미지도 삭제한다. 종류를 all로 지정하면 사용했던 모든 이미지가 삭제된다. local로 지정하면 커스텀 태크가 없는 이미지만 삭제한다. |
| `-v ,--volumes` | volumes 항목에 기재된 볼륨을 삭제한다. 단, external로 지정된 볼륨은 삭제되지 않는다.                                                                                                                                           |

#### stop

정의 파일에 기재된 컨테이너를 정지한다.

---

참고자료



---